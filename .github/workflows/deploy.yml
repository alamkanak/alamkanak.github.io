# Deploy Nuxt Portfolio to GitHub Pages (docs folder)
# This workflow builds and deploys the Nuxt static site to the docs folder
# Based on GitHub Actions best practices and Nuxt documentation
name: Deploy to GitHub Pages

on:
  # Trigger on pushes to master branch
  push:
    branches:
      - master
  # Allow manual triggering from the Actions tab
  workflow_dispatch:

# Set permissions for the workflow
permissions:
  contents: write # Needed to push to docs folder
  pages: write    # Needed for GitHub Pages deployment
  id-token: write # Needed to verify deployment source

# Prevent concurrent runs of this workflow
concurrency:
  group: github-pages
  cancel-in-progress: false

jobs:
  # Build and deploy job
  build-and-deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy to docs folder
    environment:
      name: github-pages
      url: https://alamkanak.github.io
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Use a token with write permissions
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build static site for GitHub Pages
        run: yarn build --preset github_pages
        env:
          # Set base URL for GitHub Pages (alamkanak.github.io)
          NUXT_APP_BASE_URL: /
          
      - name: Setup Git configuration
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Clean and prepare docs folder
        run: |
          # Remove existing docs folder
          rm -rf docs
          # Create docs folder
          mkdir -p docs
          # Copy build output to docs folder
          cp -r .output/public/* docs/
          # Create .nojekyll file to disable Jekyll processing
          touch docs/.nojekyll
          # Create CNAME file if needed (for custom domain)
          # echo "alamkanak.github.io" > docs/CNAME

      - name: Commit and push to docs folder
        run: |
          git add docs
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸš€ Deploy to docs folder - $(date +'%Y-%m-%d %H:%M:%S')"
            git push origin master
          fi

      - name: Deploy summary
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Site will be available at: https://alamkanak.github.io"
          echo "ğŸ“ Files deployed to docs/ folder in master branch"
